
%% solutions.sty
%% Copyright 2018 Jérôme Lelong <jerome.lelong@gmail.com>
%
% This file may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in:
%
%    http://www.latex-project.org/lppl.txt
%
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work consists of the file solutions.sty


% This package is devoted to writing exercises along with their
% solutions in a single source file.
%
% Simply add
%    \usepackage{solutions}
% This package accepts three options:
%   - 'nosol' means that the solutions are not included in the output.
%   - 'separate' indicate that the solutions should be printed right before
%   \end{document}.
%   - 'after' prints the solution of an exercise right after its text. This
%   produces a mixed document where exercise texts and their solutions
%   alternate.
%
% Without any options the solution to a question is put right behind the
% question text and ends with a black triangle at the end of the line. When
% the solution to a question ends with a dispalyed equation, we may need to
% add \endhere at the end of the equation to make sure the black triangle
% is not displayed on a separate line.
%
% Here is a typical usage
%
% \begin{exercise}[optional title]
% Some introducive text.
% \begin{enumerate}
%   \item Question 1.
%     \solution{Solution to the previous question.}
%   \item Question 2.
%     \solution{Solution to the previous question.}
% \end{enumerate}
% Add some extra gobal information if any
% \begin{enumerate}[resume]
% %% include the enumitem package to use the resume option
%   \item Question 3.
%     \solution{Solution to the previous question.}
%   \item Question 4.
%     \solution{Solution to the previous question.}
% \end{enumerate}
% \end{exercise}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{solutions}[dev version by Jerome LELONG]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifsolutions@nosol
\newif\ifsolutions@separate
\newif\ifsolutions@after
\newif\ifsolutions@inline

\solutions@nosolfalse
\solutions@separatefalse
\solutions@afterfalse
\solutions@inlinefalse

\def\solutions@opterr{%
  \PackageError{solutions}{Options 'nosol', 'inline', 'separate', 'after' are are mutually exclusive.}{}%
}

% Do not print any solution
\DeclareOption{nosol}{%
  \ifsolutions@separate\solutions@opterr\fi
  \ifsolutions@after\solutions@opterr\fi
  \ifsolutions@inline\solutions@opterr\fi
  \solutions@nosoltrue%
}

% Print each solution after its associated question
\DeclareOption{inline}{%
  \ifsolutions@separate\solutions@opterr\fi
  \ifsolutions@after\solutions@opterr\fi
  \ifsolutions@nosol\solutions@opterr\fi
  \solutions@inlinetrue%
}

% Print the solutions at the end of the document
\DeclareOption{separate}{%
  \ifsolutions@nosol\solutions@opterr\fi
  \ifsolutions@after\solutions@opterr\fi
  \ifsolutions@inline\solutions@opterr\fi
  \solutions@separatetrue
}

% Print the solutions of an exercise right after the exercise
\DeclareOption{after}{%
  \ifsolutions@separate\solutions@opterr\fi
  \ifsolutions@nosol\solutions@opterr\fi
  \ifsolutions@inline\solutions@opterr\fi
  \solutions@aftertrue
}

\DeclareOption*{%
  \PackageWarning{solutions}{Unknown option `\CurrentOption'}%
}

\ProcessOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Configuration
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\solutionsinlinename}{{\bf Solution.}\space}
\newcommand{\solutionsinlinefont}{\small \itshape}
\newcommand{\solutionsinlineendsymbol}{$\blacktriangle$}
\newcommand{\solutionsatenddocumenttitle}{\noindent {\bf Solutions}}
\newcommand{\solutionsanswerenvname}{Corrig\'e de l'exercice}

\newcommand{\solutionsexercisename}{Exercice}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environnements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{amsthm}
\RequirePackage{amsmath}
\RequirePackage{trace}

\theoremstyle{definition}
\newtheorem{exercise}{\solutionsexercisename}

\let\@exoOrig=\exercise
\let\@endexoOrig=\endexercise

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Solutions in the text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifQedDone
\def\trueendhere{%
  \leavevmode\tag*{\solutionsinlineendsymbol}%
  \global\QedDonetrue
}
\long\def\truesolution#1{
  \QedDonefalse
  \par\vskip10pt\noindent\solutionsinlinename{\solutionsinlinefont#1}%
  \ifQedDone
  \else
    \ignorespaces\unskip\penalty9999%
    \hbox{}\nobreak\hfill\hbox{\solutionsinlineendsymbol}
  \fi
  \par\vskip10pt
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Separate solutions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\gdef\solutions{}
\def\fakeendhere{}
\newif\ifStartEnum
\newif\ifEndEnum
\StartEnumfalse
\EndEnumfalse

\newenvironment{@exoSeparateSol}[1][]{%
  \StartEnumfalse
  \EndEnumfalse
  \@exoOrig[#1]%
  \g@addto@macro\solutions{%
    \vskip\baselineskip
    {\bf \noexpand\noindent \solutionsanswerenvname}}
  % Make sure \theexercise is expanded rightaway
  \edef\currentexo{{\space\noexpand\bf\theexercise.\space\noexpand}}
  \expandafter\g@addto@macro\expandafter\solutions\expandafter{\currentexo}
}
{\@endexoOrig}

\newenvironment{@exoAfterSol}[1][]{%
  \@exoOrig[#1]
  \StartEnumfalse
  \EndEnumfalse
  \gdef\solutions{}
  \g@addto@macro\solutions{%
    \vskip\baselineskip
    {\bf \noindent \solutionsanswerenvname\space\theexercise.\space}}
}
{%
  \@endexoOrig
  \solutions
}

\gdef\@enumerateOption{}
\let\@enumerateOrig\enumerate
\let\end@enumerateOrig\endenumerate
\newenvironment{questions}[1][\@empty]
  {\ifx#1\@empty
     \@enumerateOrig 
     \xdef\enumerateOption{#1}
   \else
     \@enumerateOrig[#1]
     % We use an extract macro to make sure, we do not expand the macros inside #1
     \def\currentEnumOption{#1}
     %  \show\currentEnumOption
     \expandafter\gdef\expandafter\@enumerateOption\expandafter{\currentEnumOption}
   \fi
    \StartEnumtrue
  }
  {\end@enumerateOrig%
  \ifEndEnum
    \g@addto@macro\solutions{\end{@enumerateOrig}}
  \fi}


\long\def\@separatesolution#1{%
  \ifStartEnum%
    \g@addto@macro\solutions{\begin{@enumerateOrig}}%
    % Make sure to pass enumerate options to the solutions
    \ifx\@enumerateOption\@empty \else%
      \expandafter\g@addto@macro\expandafter\solutions\expandafter{\expandafter[\@enumerateOption]}%
    \fi%
    \EndEnumtrue%
  \fi%
  \ifEndEnum%
    \g@addto@macro\solutions{\item #1}%
  \else%
    \g@addto@macro\solutions{#1}%
  \fi%
  \StartEnumfalse%
  \ignorespaces%
}

\ifsolutions@nosol%
  \long\def\@Solution#1{}
\else%
  \ifsolutions@separate
    \def\endhere{\fakeendhere}
    \let\@Solution\@separatesolution
    \let\exercise\@exoSeparateSol
    \let\endexercise\end@exoSeparateSol
    \AtEndDocument{%
      \solutionsatenddocumenttitle
      \solutions
    }
  \else
    \ifsolutions@after
      \def\endhere{\fakeendhere}
      \let\@Solution\@separatesolution
      \let\exercise\@exoAfterSol
      \let\endexercise\end@exoAfterSol
    \else%
      \def\endhere{\trueendhere}
      \long\def\@Solution#1{\truesolution{#1}}
    \fi%
  \fi%
\fi%
\let\solution\@Solution

% Compatibility definitions
\let\exo=\exercise
\let\endexo=\endexercise

\endinput

%% End of file `solutions.sty'.
